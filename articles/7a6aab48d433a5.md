---
title: "Discord ã‚µãƒ¼ãƒãƒ¼ã‚’å®ˆã‚‹ ãƒ­ãƒ¼ãƒ«èªè¨¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ãŸè©±"
emoji: "ğŸ›¡ï¸"
type: "tech"
topics: ["cloudflareworkers", "hono", "discord"]
published: true
---

## ã¯ã˜ã‚ã«

ç§ã¯é€šä¿¡é«˜æ ¡ã«é€šã£ã¦ãŠã‚Šã€åŒå¥½ä¼šã®é‹å–¶ã‚’è¡Œã£ã¦ã„ã¾ã™
ã—ã‹ã—ã€æ˜¨æ—¥ã‚µãƒ¼ãƒãƒ¼ã®æ‹›å¾…ãƒªãƒ³ã‚¯ãŒå­¦åœ’å¤–ã«æ¼ã‚Œã¦ã—ã¾ã„ã€ç¬¬ä¸‰è€…ãŒä¸æ­£ã«å‚åŠ ã™ã‚‹äº‹æ…‹ãŒç™ºç”Ÿã—ã¾ã—ãŸ
ã“ã®å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ç‰¹å®šã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã‘ãŒã‚µãƒ¼ãƒãƒ¼ã«å‚åŠ ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹èªè¨¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã—ãŸ

æœ¬è¨˜äº‹ã§ã¯ã€ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…å†…å®¹ã‚„ã€é–‹ç™ºã«ãŠã„ã¦å·¥å¤«ã—ãŸç‚¹ã‚’ç´¹ä»‹ã—ã¾ã™

## ã‚¢ãƒ—ãƒªã®æ¦‚è¦

ã“ã®ã‚¢ãƒ—ãƒªã¯ã€Cloudflare Workers ã¨ Hono ã‚’ä½¿ç”¨ã—ã¦ã€Discord ã‚µãƒ¼ãƒãƒ¼ã®ãƒ¡ãƒ³ãƒãƒ¼ã«ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã™ã‚‹ä»•çµ„ã¿ã‚’æä¾›ã—ã¾ã™
èªè¨¼ã«ã¯ Discord OAuth2 ã¨ Google OAuth2 ã‚’åˆ©ç”¨ã—ã€æŒ‡å®šã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒèªè¨¼ã‚’é€šéã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™

### ä¸»ãªæ©Ÿèƒ½

- Discord OAuth2 ã‚’åˆ©ç”¨ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
- Google OAuth2 ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã—ã€ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
- è¨±å¯ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ Discord ã®ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸
- JWT ã¨ CSRF å¯¾ç­–ã‚’æ–½ã—ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–

## å®Ÿè£…ã§é ‘å¼µã£ãŸéƒ¨åˆ†

### 1. CSRF å¯¾ç­–

OAuth2 ã® `state` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã€CSRF æ”»æ’ƒã‚’é˜²ãä»•çµ„ã¿ã‚’å®Ÿè£…ã—ã¾ã—ãŸ
å…·ä½“çš„ã«ã¯ã€èªè¨¼é–‹å§‹æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ãª `state` å€¤ã‚’ç”Ÿæˆã—ã€ã‚¯ãƒƒã‚­ãƒ¼ã«ä¿å­˜ã—ã¦ãŠã
èªè¨¼å¾Œã«è¿”ã£ã¦ããŸ `state` å€¤ã¨ç…§åˆã—ã€ä¸€è‡´ã—ãªã„å ´åˆã¯èªè¨¼ã‚’æ‹’å¦ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ
[index.ts (Lines 21 to 36 in 9e3c108)](https://github.com/minagishl/discord-email-auth/blob/9e3c1084053218d76aacd9b596fd9ddd0ef4dda1/src/index.ts#L21-L36)

```ts
// Function to generate state for CSRF protection
async function generateState(): Promise<string> {
  const buffer = new Uint8Array(32);
  crypto.getRandomValues(buffer);
  const state = Array.from(buffer)
    .map((b) => b.toString(16).padStart(2, "0"))
    .join("");
  return state;
}

// Validate the CSRF token
function validateState(c: Context, state: string): boolean {
  const savedState = getCookie(c, "oauth_state");
  deleteCookie(c, "oauth_state");
  return savedState === state;
}
```

### 2. JWT ã«ã‚ˆã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

Discord ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã‚’å®‰å…¨ã«ä¿å­˜ã™ã‚‹ãŸã‚ã€JWT ã‚’ä½¿ç”¨ã—ã¾ã—ãŸ
JWT ã®ç½²åã«ã¯ç’°å¢ƒå¤‰æ•° `JWT_SECRET` ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€å®‰å…¨æ€§ã‚’ç¢ºä¿ã—ã¦ã„ã¾ã™
[index.ts (Lines 118 to 125 in 9e3c108)](https://github.com/minagishl/discord-email-auth/blob/9e3c1084053218d76aacd9b596fd9ddd0ef4dda1/src/index.ts#L118-L125)

```ts
// Save discordUserId safely with JWT
const jwt = await sign({ discordUserId }, c.env.JWT_SECRET);
setCookie(c, "discord_user", jwt, {
  httpOnly: true,
  secure: true,
  sameSite: "Lax",
  maxAge: 600,
});
```

### 3. ãƒ¡ãƒ¼ãƒ«ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒã‚§ãƒƒã‚¯

Google OAuth2 ã‚’ä½¿ç”¨ã—ã¦å–å¾—ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ç‰¹å®šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚’è¨±å¯ã—ã¾ã™
[index.ts (Lines 212 to 216 in 9e3c108)](https://github.com/minagishl/discord-email-auth/blob/9e3c1084053218d76aacd9b596fd9ddd0ef4dda1/src/index.ts#L212-L216)

```ts
const allowedDomains = ["nnn.ed.jp", "n-jr.jp", "nnn.ac.jp"];
const emailDomain = email.split("@")[1];
if (!allowedDomains.includes(emailDomain)) {
  return c.json({ error: "Email domain not allowed" }, 403);
}
```

### 4. Discord ãƒ­ãƒ¼ãƒ«ã®ä»˜ä¸

èªè¨¼ã‚’é€šéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Discord ã® API ã‚’ç”¨ã„ã¦ç‰¹å®šã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã¾ã™
[index.ts (Lines 245 to 255 in 9e3c108)](https://github.com/minagishl/discord-email-auth/blob/9e3c1084053218d76aacd9b596fd9ddd0ef4dda1/src/index.ts#L245-L255)

```ts
// Assign a role
const roleResponse = await fetch(
  `${c.env.DISCORD_API_BASE}/guilds/${c.env.DISCORD_GUILD_ID}/members/${discordUserId}/roles/${c.env.DISCORD_ROLE_ID}`,
  {
    method: "PUT",
    headers: {
      Authorization: `Bot ${c.env.DISCORD_BOT_TOKEN}`,
      "Content-Type": "application/json",
    },
  },
);
```

## ã¾ã¨ã‚

ä»Šå›ã€Discord ã‚µãƒ¼ãƒãƒ¼ã®å®‰å…¨æ€§ã‚’å‘ä¸Šã•ã›ã‚‹ãŸã‚ã«ã€ãƒ­ãƒ¼ãƒ«èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã¾ã—ãŸ
ç§ã«ã¨ã£ã¦åˆã‚ã¦ã® JWT ã‚„ CSRF å¯¾ç­–ã®å®Ÿè£…ã§ã—ãŸãŒã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®é‡è¦æ€§ã‚’å®Ÿæ„Ÿã—ãªãŒã‚‰å­¦ã¶è‰¯ã„æ©Ÿä¼šã¨ãªã‚Šã¾ã—ãŸ
ä»Šå¾Œã‚‚ã‚ˆã‚Šå®‰å…¨ã§ä½¿ã„ã‚„ã™ã„ä»•çµ„ã¿ã‚’è€ƒãˆã€æ”¹å–„ã‚’ç¶šã‘ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™
